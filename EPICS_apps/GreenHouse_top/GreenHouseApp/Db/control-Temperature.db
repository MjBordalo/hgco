# author: Miguel Bordalo
#
# This document presents the PV in order to control the greenhouse Temperature
#


#################################################
#		Calc - Variables based on calculations
#################################################
# Error computationâ€™ s SCAN drives the rest
record(calc, "$(user):TempError")
{
		field(DESC, "Temperature Error")
		field(SCAN, "60 second")
		field(INPA, "$(user):Temp1")
		field(INPB, "$(user):TempSetpoint")
		field(CALC, "A-B")
		field(PREC, "1")
}

# Proportional Feedback signal
# u = Kp*TempError
# TempError = Temp1- TempSetpoint
record(calc, "$(user):TempPID")
{
		field(DESC, "GreenHouse Temp PID")
		field(PREC, "0")
		field(SCAN, "2 second")

		field(LOPR, "0")			#<--- Isto faz alguma coisa aqui?
		field(HOPR, "170")
		field(INPA, "60")			#Kp
		field(INPB, "$(user):TempError")
		field(CALC, "A*B")
}
# Proportional Feedback signal
# u = Kp*TempError
# TempError = Temp1- TempSetpoint
record(calc, "$(user):FanPID")
{
		field(DESC, "GreenHouse Temp PID")
		field(PREC, "0")
		field(SCAN, "2 second")

		field(LOPR, "15")
		field(HOPR, "255")
		field(INPA, "40")			#Kp
		field(INPB, "$(user):TempError")
		field(CALC, "A*B > 15 ? A*B: 15")
		field(FLNK,	"miHost:Fan PP")
}

###################################
# Setpoints
###################################
record(ao, "$(user):TempSetpoint"){
	info(autosaveFields, "VAL")		#autosave
	field(DTYP, "Soft Channel")	#this is done by default
	#field(SCAN, "2 second")
	field(VAL, "20")		#init setpoint
	field(DRVH, "40")
	field(DRVL, "10")
	field(PINI,	"YES")
}

#############################
#   Debug
#############################
record(stringin , "$(user):ExpString"){
	info(autosaveFields, "VAL")		#autosave
	field(VAL, "no experience")
	field(DESC, "anotar estados da experiencia")
	field(PINI,"YES")
}

#################
# Pi
#############
#record (stringin, $(user):PiTemp {
#    field (DTYP, "stream")
#    field (INP,  "@arduino.proto getPiTemp() $(PORT)")
#}
